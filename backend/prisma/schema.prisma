// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id            String    @id @default(uuid())
  username      String    @unique
  email         String    @unique
  password      String    // bcrypt hashed
  fullName      String?   @map("full_name")
  role          String    @default("member") // owner, editor, contributor, member
  emailVerified Boolean   @default(false) @map("email_verified")
  enabled       Boolean   @default(true)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  firstLogin    DateTime? @map("first_login")
  lastLogin     DateTime? @map("last_login")

  // Relations
  refreshTokens       RefreshToken[]
  auditLogs           AuditLog[]
  submittedProposals  ChangeProposal[] @relation("SubmittedProposals")
  reviewedProposals   ChangeProposal[] @relation("ReviewedProposals")

  @@map("users")
}

// JWT Refresh Tokens
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revoked   Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// Genealogy Core Models
model Person {
  id           String   @id @default(uuid())
  handle       String   @unique
  grampsId     String   @unique @map("gramps_id")
  gender       Int      @default(2) // 0=Female, 1=Male, 2=Unknown
  private      Boolean  @default(false)
  firstName    String?  @map("first_name")
  surname      String?
  callName     String?  @map("call_name")
  birthDate    String?  @map("birth_date")
  birthPlace   String?  @map("birth_place")
  deathDate    String?  @map("death_date")
  deathPlace   String?  @map("death_place")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // JSON fields for complex nested data
  primaryName  String?  @map("primary_name") // JSON
  profile      String?  // JSON
  mediaList    String?  @map("media_list") // JSON array
  eventRefList String?  @map("event_ref_list") // JSON array

  // Relations
  familiesAsParent Family[] @relation("FatherFamilies")
  familiesAsMother Family[] @relation("MotherFamilies")
  familiesAsChild  Family[] @relation("ChildFamilies")
  events           Event[]

  @@map("people")
}

model Family {
  id           String   @id @default(uuid())
  handle       String   @unique
  grampsId     String   @unique @map("gramps_id")
  fatherHandle String?  @map("father_handle")
  motherHandle String?  @map("mother_handle")
  type         Int      @default(0) // 0=Unknown, 1=Married, 2=Unmarried, etc.
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // JSON fields
  childRefList String? @map("child_ref_list") // JSON array
  eventRefList String? @map("event_ref_list") // JSON array

  // Relations
  father   Person?  @relation("FatherFamilies", fields: [fatherHandle], references: [handle])
  mother   Person?  @relation("MotherFamilies", fields: [motherHandle], references: [handle])
  children Person[] @relation("ChildFamilies")

  @@map("families")
}

model Event {
  id          String   @id @default(uuid())
  handle      String   @unique
  grampsId    String   @unique @map("gramps_id")
  type        String   // Birth, Death, Marriage, etc.
  date        String?
  place       String?
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  personHandle String? @map("person_handle")
  person       Person? @relation(fields: [personHandle], references: [handle])

  @@map("events")
}

model Place {
  id        String   @id @default(uuid())
  handle    String   @unique
  grampsId  String   @unique @map("gramps_id")
  name      String
  title     String?
  latitude  Float?
  longitude Float?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // JSON fields
  placeType String? @map("place_type") // JSON
  hierarchy String? // JSON array

  @@map("places")
}

model Media {
  id        String   @id @default(uuid())
  handle    String   @unique
  grampsId  String   @unique @map("gramps_id")
  path      String
  mimeType  String?  @map("mime_type")
  desc      String?
  checksum  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("media")
}

model Repository {
  id        String   @id @default(uuid())
  handle    String   @unique
  grampsId  String   @unique @map("gramps_id")
  name      String
  type      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("repositories")
}

model Source {
  id        String   @id @default(uuid())
  handle    String   @unique
  grampsId  String   @unique @map("gramps_id")
  title     String
  author    String?
  pubInfo   String?  @map("pub_info")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("sources")
}

model Note {
  id        String   @id @default(uuid())
  handle    String   @unique
  grampsId  String   @unique @map("gramps_id")
  content   String
  type      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notes")
}

// System Models
model Metadata {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   // JSON
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("metadata")
}

model TreeSettings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   // JSON
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tree_settings")
}

// Audit Log for tracking changes (Enhanced for Phase 13)
model AuditLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  action     String   // CREATE, UPDATE, DELETE
  entityType String   @map("entity_type") // Person, Family, etc.
  entityId   String   @map("entity_id")
  changes    String?  // JSON of changes (before/after state)
  timestamp  DateTime @default(now())
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  rolledBack Boolean  @default(false) @map("rolled_back")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp])
}

// Change Proposals for Approval Workflows
model ChangeProposal {
  id          String   @id @default(uuid())
  submitterId String   @map("submitter_id")
  reviewerId  String?  @map("reviewer_id")
  entityType  String   @map("entity_type") // Person, Family, etc.
  entityId    String?  @map("entity_id") // null for new entities
  operation   String   // CREATE, UPDATE, DELETE
  proposedChanges String @map("proposed_changes") // JSON of proposed changes
  currentState String? @map("current_state") // JSON of current state (for updates)
  status      String   @default("pending") // pending, approved, rejected
  comment     String?  // Reviewer comment
  submittedAt DateTime @default(now()) @map("submitted_at")
  reviewedAt  DateTime? @map("reviewed_at")

  submitter User  @relation("SubmittedProposals", fields: [submitterId], references: [id], onDelete: Cascade)
  reviewer  User? @relation("ReviewedProposals", fields: [reviewerId], references: [id])

  @@map("change_proposals")
  @@index([status])
  @@index([submitterId])
  @@index([reviewerId])
}

// Backup Jobs for scheduled backups
model BackupJob {
  id           String   @id @default(uuid())
  status       String   @default("pending") // pending, running, completed, failed
  type         String   // manual, scheduled
  destination  String   // local, s3, google-drive
  filePath     String?  @map("file_path")
  fileSize     Int?     @map("file_size")
  encrypted    Boolean  @default(false)
  compression  String?  // gzip, zip, none
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  errorMessage String?  @map("error_message")
  createdBy    String?  @map("created_by")
  metadata     String?  // JSON for additional info

  @@map("backup_jobs")
  @@index([status])
  @@index([startedAt])
}

// System Health Metrics
model SystemHealth {
  id            String   @id @default(uuid())
  timestamp     DateTime @default(now())
  cpuUsage      Float?   @map("cpu_usage")
  memoryUsage   Float?   @map("memory_usage")
  diskUsage     Float?   @map("disk_usage")
  dbSize        Int?     @map("db_size") // in bytes
  dbConnections Int?     @map("db_connections")
  requestCount  Int?     @map("request_count")
  errorCount    Int?     @map("error_count")
  activeUsers   Int?     @map("active_users")
  metadata      String?  // JSON for additional metrics

  @@map("system_health")
  @@index([timestamp])
}
